<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WhatsApp Style Chat</title>
  
  
  <style type="text/css" media="all">
    :root {
  /* ‡¶ï‡¶æ‡¶≤‡¶æ‡¶∞ ‡¶≠‡ßá‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶¨‡¶≤ */
  --primary-color: #128C7E;
  --primary-dark: #075E54;
  --primary-light: #25D366;
  --accent-color: #53BDEB;
  --text-light: #FFFFFF;
  --text-dark: #111B21;
  --bg-light: #F0F2F5;
  --bg-dark: #0C1317;
  --message-received: #FFFFFF;
  --message-sent: #D9FDD3;
  --header-light: #F0F2F5;
  --header-dark: #202C33;
  --input-light: #FFFFFF;
  --input-dark: #2A3942;
  --shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
  --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
}

body {
  background-color: var(--bg-light);
  height: 100vh;
  display: flex;
  flex-direction: column;
  transition: var(--transition);
}

body.dark-mode {
  background-color: var(--bg-dark);
  color: var(--text-light);
}

/* ‡¶≤‡¶ó‡¶ø‡¶® ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞ */
.login-container {
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.login-box {
  background-color: var(--text-light);
  border-radius: 12px;
  padding: 40px;
  width: 100%;
  max-width: 420px;
  box-shadow: var(--shadow);
  transform: translateY(0);
  transition: var(--transition);
}

.login-box:hover {
  transform: translateY(-5px);
  box-shadow: 0 14px 28px rgba(0,0,0,0.1), 0 10px 10px rgba(0,0,0,0.08);
}

.login-logo {
  text-align: center;
  color: var(--primary-dark);
  margin-bottom: 32px;
}

.login-logo i {
  font-size: 48px;
  margin-bottom: 16px;
  color: var(--primary-color);
}

.login-logo h2 {
  font-size: 28px;
  font-weight: 600;
}

.google-login-button {
  width: 100%;
  padding: 14px;
  background-color: var(--text-light);
  color: #5F6368;
  border: 1px solid #DADCE0;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  box-shadow: var(--shadow);
}

.google-login-button:hover {
  background-color: #F8F9FA;
  transform: translateY(-2px);
}

.google-login-button i {
  color: #4285F4;
  font-size: 20px;
}

/* ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞ */
.container {
  max-width: 1000px;
  margin: 0 auto;
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  background-color: var(--bg-light);
  box-shadow: var(--shadow);
  position: relative;
  overflow: hidden;
}

.dark-mode .container {
  background-color: var(--bg-dark);
}

/* ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶π‡ßá‡¶°‡¶æ‡¶∞ */
.chat-header {
  background-color: var(--header-light);
  padding: 12px 20px;
  display: flex;
  align-items: center;
  height: 70px;
  border-bottom: 1px solid rgba(0,0,0,0.08);
  z-index: 10;
}

.dark-mode .chat-header {
  background-color: var(--header-dark);
  border-bottom: 1px solid rgba(255,255,255,0.08);
}

.user-avatar {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background-color: var(--primary-color);
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 16px;
  color: var(--text-light);
  font-size: 20px;
  font-weight: 600;
  flex-shrink: 0;
}

.user-info {
  flex-grow: 1;
}

.user-name {
  font-weight: 600;
  font-size: 17px;
  color: var(--text-dark);
  margin-bottom: 2px;
}

.dark-mode .user-name {
  color: var(--text-light);
}

.user-status {
  font-size: 13px;
  color: #667781;
  display: flex;
  align-items: center;
}

.header-icons {
  display: flex;
  gap: 24px;
}

.header-icons i {
  color: #54656F;
  font-size: 22px;
  cursor: pointer;
  transition: var(--transition);
}

.dark-mode .header-icons i {
  color: #AEBAC1;
}

.header-icons i:hover {
  color: var(--primary-color);
  transform: scale(1.1);
}

/* ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶è‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ */
.chat-messages {
  flex-grow: 1;
  padding: 20px;
  overflow-y: auto;
  background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAGKADAAQAAAABAAAAGAAAAADB/VeXAAAAc0lEQVRIDe2USwrAMAgFc/8bNWeRWElLU2gdELowH3FePMX6Ofz12vPpUxYDKMARYACJAAbAv4BzJ/s8lh7t1r0RJPvUZUAdVGCOJFUjqeLOZN9qvoqU982I2uaYVDNpBBKLZpD2ZhbNIO3NLJoB5cV/ZmwB2wIozUMFLdsAAAAASUVORK5CYII=');
  background-repeat: repeat;
  background-color: #EFEAE2;
  display: flex;
  flex-direction: column;
}

.dark-mode .chat-messages {
  background-color: #0B141A;
  background-image: none;
}

.message-container {
  display: flex;
  flex-direction: column;
  margin-bottom: 8px;
  max-width: 80%;
  align-self: flex-start;
}

.message-container.sent {
  align-self: flex-end;
}

.message {
  border-radius: 7.5px;
  padding: 8px 12px;
  position: relative;
  word-wrap: break-word;
  box-shadow: var(--shadow);
  transition: var(--transition);
}

.message.received {
  background-color: var(--message-received);
  border-top-left-radius: 0;
  color: var(--text-dark);
}

.dark-mode .message.received {
  background-color: var(--input-dark);
  color: var(--text-light);
}

.message.sent {
  background-color: var(--message-sent);
  border-top-right-radius: 0;
  color: var(--text-dark);
}

.message-time {
  font-size: 11px;
  color: #667781;
  text-align: right;
  margin-top: 4px;
  display: flex;
  align-items: center;
  justify-content: flex-end;
  gap: 4px;
}

.message.sent .message-time {
  color: #1FA855;
}

.read-receipt {
  color: var(--accent-color);
  font-size: 14px;
}

/* ‡¶ü‡¶æ‡¶á‡¶™‡¶ø‡¶Ç ‡¶á‡¶®‡ßç‡¶°‡¶ø‡¶ï‡ßá‡¶ü‡¶∞ */
.typing-indicator {
  display: inline-flex;
  padding: 8px 12px;
  background-color: var(--message-received);
  border-radius: 15px;
  margin-top: 4px;
  align-items: center;
}

.dark-mode .typing-indicator {
  background-color: var(--input-dark);
}

.typing-dot {
  width: 6px;
  height: 6px;
  background: #667781;
  border-radius: 50%;
  margin: 0 2px;
  animation: typing 1.4s infinite;
}

.dark-mode .typing-dot {
  background: #AEBAC1;
}

.typing-text {
  font-size: 12px;
  color: #667781;
  margin-left: 6px;
}

.dark-mode .typing-text {
  color: #AEBAC1;
}

@keyframes typing {
  0%, 60%, 100% { transform: translateY(0); }
  30% { transform: translateY(-3px); }
}

/* ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶á‡¶®‡¶™‡ßÅ‡¶ü */
.chat-input {
  padding: 12px 16px;
  background-color: var(--header-light);
  display: flex;
  align-items: center;
  border-top: 1px solid rgba(0,0,0,0.08);
  position: relative;
}

.dark-mode .chat-input {
  background-color: var(--header-dark);
  border-top: 1px solid rgba(255,255,255,0.08);
}

.input-icons {
  color: #54656F;
  font-size: 24px;
  padding: 0 12px;
  cursor: pointer;
  transition: var(--transition);
}

.dark-mode .input-icons {
  color: #AEBAC1;
}

.input-icons:hover {
  color: var(--primary-color);
  transform: scale(1.1);
}

.message-input {
  flex-grow: 1;
  padding: 12px 16px;
  background-color: var(--input-light);
  border: none;
  border-radius: 8px;
  margin: 0 8px;
  font-size: 15px;
  resize: none;
  max-height: 120px;
  transition: var(--transition);
}

.dark-mode .message-input {
  background-color: var(--input-dark);
  color: var(--text-light);
}

.message-input:focus {
  outline: none;
  box-shadow: 0 0 0 2px var(--primary-color);
}

.send-button {
  background-color: var(--primary-color);
  border: none;
  cursor: pointer;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: var(--transition);
}

.send-button:hover {
  background-color: var(--primary-dark);
  transform: scale(1.05);
}

.send-button i {
  color: var(--text-light);
  font-size: 17px;
}

/* ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶ï‡¶≤ ‡¶∏‡ßá‡¶ï‡¶∂‡¶® */
.video-call-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.9);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  flex-direction: column;
}

.video-call-box {
  width: 90%;
  max-width: 900px;
  background: rgba(30,30,30,0.9);
  border-radius: 15px;
  padding: 30px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 20px;
  position: relative;
}

.call-user-info {
  text-align: center;
  color: white;
  margin-bottom: 20px;
}

.call-user-name {
  font-size: 24px;
  font-weight: 600;
  margin-bottom: 8px;
}

.call-status {
  font-size: 16px;
  color: #DDDDDD;
}

.video-container {
  width: 100%;
  position: relative;
  border-radius: 10px;
  overflow: hidden;
}

#remoteVideo {
  width: 100%;
  max-height: 60vh;
  background: #000;
  border-radius: 10px;
}

#localVideo {
  position: absolute;
  bottom: 20px;
  right: 20px;
  width: 180px;
  border: 2px solid white;
  border-radius: 8px;
  background: #000;
}

.call-controls {
  display: flex;
  gap: 20px;
  margin-top: 20px;
}

.call-button {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: rgba(255,255,255,0.1);
  border: none;
  color: white;
  font-size: 24px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: var(--transition);
}

.call-button:hover {
  background: rgba(255,255,255,0.2);
  transform: scale(1.05);
}

.call-button.end-call {
  background: #FF3B30;
}

.call-button.end-call:hover {
  background: #FF5E52;
}

.call-id-container {
  display: flex;
  gap: 10px;
  margin-top: 20px;
  width: 100%;
  max-width: 500px;
}

#callIdInput {
  flex-grow: 1;
  padding: 12px 16px;
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 8px;
  color: white;
  font-size: 16px;
}

#callIdInput:focus {
  outline: none;
  border-color: var(--primary-color);
}

.call-id-button {
  padding: 12px 24px;
  background: var(--primary-color);
  border: none;
  border-radius: 8px;
  color: white;
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
}

.call-id-button:hover {
  background: var(--primary-dark);
}

/* ‡¶•‡¶ø‡¶Æ ‡¶ü‡¶ó‡¶≤ ‡¶¨‡¶æ‡¶ü‡¶® */
.theme-toggle {
  background: transparent;
  border: none;
  color: #54656F;
  font-size: 22px;
  cursor: pointer;
  transition: var(--transition);
  margin-left: auto;
}

.dark-mode .theme-toggle {
  color: #AEBAC1;
}

.theme-toggle:hover {
  color: var(--primary-color);
  transform: rotate(30deg);
}

/* ‡¶∞‡ßá‡¶∏‡ßç‡¶™‡¶®‡ßç‡¶∏‡¶ø‡¶≠ ‡¶°‡¶ø‡¶ú‡¶æ‡¶á‡¶® */
@media (max-width: 768px) {
  .container {
    max-width: 100%;
    border-radius: 0;
  }
  
  .message {
    max-width: 90%;
  }
  
  .header-icons {
    gap: 16px;
  }
  
  .video-call-box {
    width: 100%;
    border-radius: 0;
    height: 100%;
  }
  
  #localVideo {
    width: 120px;
  }
}

@media (min-width: 769px) and (max-width: 1024px) {
  .container {
    max-width: 95%;
  }
}
    
  </style>
  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <!-- Login Container -->
  <div id="login-container" class="login-container">
    <div class="login-box">
      <div class="login-logo">
        <i class="fab fa-whatsapp fa-3x"></i>
        <h2>WhatsApp Chat</h2>
      </div>
      <div class="login-form">
        <button id="google-login" class="google-login-button">
          <i class="fab fa-google"></i> Sign in with Google
        </button>
      </div>
    </div>
  </div>
  
  <!-- Chat Container -->
  <div id="chat-container" class="container" style="display:none;">
    <div class="chat-header">
      <div class="user-avatar">
        <div id="chat-avatar" class="avatar-initial">?</div>
      </div>
      <div class="user-info">
        <div id="chat-user-name" class="user-name">User</div>
        <div class="user-status">online</div>
      </div>
      <div class="header-icons">
        <button id="theme-toggle" class="theme-toggle">
          <i class="fas fa-moon"></i>
        </button>
        <i class="fas fa-video" onclick="startCall()"></i>
        <i class="fas fa-phone"></i>
        <i class="fas fa-search"></i>
        <i class="fas fa-ellipsis-v"></i>
      </div>
    </div>
    
    <div id="chat-messages" class="chat-messages">
      <div id="typing-indicator" class="typing-indicator" style="display: none;">
        <div class="typing-dot" style="animation-delay: 0s"></div>
        <div class="typing-dot" style="animation-delay: 0.2s"></div>
        <div class="typing-dot" style="animation-delay: 0.4s"></div>
        <span class="typing-text">Typing...</span>
      </div>
    </div>
    
    <div class="chat-input">
      <div class="input-icons">
        <i class="far fa-smile"></i>
      </div>
      <div class="input-icons">
        <i class="fas fa-paperclip"></i>
      </div>
      <input type="text" id="message-input" class="message-input" placeholder="Type a message">
      <button id="send-button" class="send-button">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>
<!-- Video Call Section -->
<div id="videoCallContainer" class="video-call-container">
  <div class="video-call-box">
    <div class="call-user-info">
      <div id="callUserName" class="call-user-name">User</div>
      <div id="callStatus" class="call-status">Calling...</div>
    </div>
    
    <div class="video-container">
      <video id="remoteVideo" autoplay playsinline></video>
      <video id="localVideo" autoplay playsinline muted></video>
    </div>
    
    <div class="call-controls">
      <button class="call-button" onclick="toggleMute()">
        <i class="fas fa-microphone"></i>
      </button>
      <button class="call-button" onclick="toggleVideo()">
        <i class="fas fa-video"></i>
      </button>
      <button class="call-button end-call" onclick="hangUp()">
        <i class="fas fa-phone"></i>
      </button>
    </div>
  </div>
</div>


<script type="text/javascript" charset="utf-8">
  
  // Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyB_Q4ua3obYqJyNSbjcf8YDp_tgk0sVeqo",
  authDomain: "file-inport-text.firebaseapp.com",
  databaseURL: "https://file-inport-text-default-rtdb.firebaseio.com",
  projectId: "file-inport-text",
  storageBucket: "file-inport-text.firebasestorage.app",
  messagingSenderId: "812561149444",
  appId: "1:812561149444:web:7b7ef708c13bd6dc65cf51",
  measurementId: "G-9PCENJPS8R"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
const firestore = firebase.firestore();

// DOM Elements
const loginContainer = document.getElementById('login-container');
const chatContainer = document.getElementById('chat-container');
const chatMessages = document.getElementById('chat-messages');
const messageInput = document.getElementById('message-input');
const sendButton = document.getElementById('send-button');
const googleLoginButton = document.getElementById('google-login');
const chatUserName = document.getElementById('chat-user-name');
const chatAvatar = document.getElementById('chat-avatar');
const typingIndicator = document.getElementById('typing-indicator');
const videoCallContainer = document.getElementById('videoCallContainer');
const callUserName = document.getElementById('callUserName');
const callStatus = document.getElementById('callStatus');
const callIdInput = document.getElementById('callIdInput');

// Theme Toggle
document.getElementById('theme-toggle').addEventListener('click', () => {
  document.body.classList.toggle('dark-mode');
  const icon = document.querySelector('#theme-toggle i');
  if (document.body.classList.contains('dark-mode')) {
    icon.classList.remove('fa-moon');
    icon.classList.add('fa-sun');
  } else {
    icon.classList.remove('fa-sun');
    icon.classList.add('fa-moon');
  }
  localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
});

// Check theme on page load
if (localStorage.getItem('darkMode') === 'true') {
  document.body.classList.add('dark-mode');
  const icon = document.querySelector('#theme-toggle i');
  icon.classList.remove('fa-moon');
  icon.classList.add('fa-sun');
}

// Google Auth Provider
const provider = new firebase.auth.GoogleAuthProvider();

// Google Login Function
googleLoginButton.addEventListener('click', () => {
  firebase.auth().signInWithPopup(provider)
    .then((result) => {
      console.log("Google sign-in successful");
    })
    .catch((error) => {
      alert("Google login error: " + error.message);
    });
});

// Auth state change listener
firebase.auth().onAuthStateChanged(user => {
  if (user) {
    loginContainer.style.display = "none";
    chatContainer.style.display = "flex";
    
    let displayName = user.displayName || user.email.split('@')[0];
    const initials = displayName.charAt(0).toUpperCase();
    chatAvatar.textContent = initials;
    chatUserName.textContent = displayName;
    callUserName.textContent = displayName;
    
    const colors = ['#25D366', '#128C7E', '#075E54', '#34B7F1'];
    chatAvatar.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
  } else {
    loginContainer.style.display = "flex";
    chatContainer.style.display = "none";
  }
});

// Send message function
function sendMessage() {
  const text = messageInput.value.trim();
  const user = firebase.auth().currentUser;
  
  if (text && user) {
    db.ref('chat').push({
      text: text,
      user: user.email,
      time: Date.now(),
      type: 'text'
    });
    messageInput.value = "";
  }
}

// Send call ID function
function sendCallId(callId) {
  const user = firebase.auth().currentUser;
  if (user) {
    db.ref('chat').push({
      text: callId,
      user: user.email,
      time: Date.now(),
      type: 'call'
    });
  }
}

// Send message on button click
sendButton.addEventListener('click', sendMessage);

// Send message on Enter key
messageInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    sendMessage();
  }
});

// Typing indicator
let typingTimer;
messageInput.addEventListener('input', () => {
  typingIndicator.style.display = 'flex';
  clearTimeout(typingTimer);
  typingTimer = setTimeout(() => {
    typingIndicator.style.display = 'none';
  }, 2000);
});

// Listen for new messages
db.ref('chat').on('child_added', snapshot => {
  const data = snapshot.val();
  const currentUser = firebase.auth().currentUser;
  
  if (currentUser) {
    const isSent = data.user === currentUser.email;
    const date = new Date(data.time);
    const hours = date.getHours().toString().padStart(2, '0');
    const minutes = date.getMinutes().toString().padStart(2, '0');
    const timeString = `${hours}:${minutes}`;
    
    const messageContainer = document.createElement('div');
    messageContainer.className = `message-container ${isSent ? 'sent' : ''}`;
    
    const messageElement = document.createElement('div');
    messageElement.className = `message ${isSent ? 'sent' : 'received'}`;
    
    if (data.type === 'call') {
      messageElement.style.backgroundColor = '#e9edef';
      messageElement.style.cursor = 'pointer';
      messageElement.innerHTML = `
        <div class="message-text">Video Call ID: ${data.text} (Click to join)</div>
        <div class="message-time">${timeString} <i class="fas fa-video read-receipt"></i></div>
      `;
      messageElement.onclick = () => {
        callIdInput.value = data.text;
        answerCall();
      };
    } else {
      messageElement.innerHTML = `
        <div class="message-text">${data.text}</div>
        <div class="message-time">${timeString} ${isSent ? '<i class="fas fa-check read-receipt"></i>' : ''}</div>
      `;
    }
    
    messageContainer.appendChild(messageElement);
    chatMessages.insertBefore(messageContainer, typingIndicator);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }
});

// Emoji picker placeholder
document.querySelector('.fa-smile').addEventListener('click', () => {
  messageInput.value += 'üòä';
  messageInput.focus();
});

// Attachment placeholder
document.querySelector('.fa-paperclip').addEventListener('click', () => {
  alert('Attachment feature would be implemented here');
});

// WebRTC Setup
const servers = {
  iceServers: [
    { urls: 'stun:stun.l.google.com:19302' }
  ]
};
let peerConnection;
let localStream;
let callDoc;
let isMuted = false;
let isVideoOff = false;

// Start video call
async function startCall() {
  try {
    callStatus.textContent = "Starting call...";
    videoCallContainer.style.display = 'flex';
    
    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    document.getElementById('localVideo').srcObject = localStream;

    callDoc = firestore.collection('calls').doc();
    const offerCandidates = callDoc.collection('offerCandidates');
    const answerCandidates = callDoc.collection('answerCandidates');

    peerConnection = new RTCPeerConnection(servers);
    localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

    peerConnection.onicecandidate = event => {
      if (event.candidate) {
        offerCandidates.add(event.candidate.toJSON());
      }
    };

    peerConnection.ontrack = event => {
      document.getElementById('remoteVideo').srcObject = event.streams[0];
      callStatus.textContent = "Call connected";
    };

    const offer = await peerConnection.createOffer();
    await peerConnection.setLocalDescription(offer);

    await callDoc.set({ 
      offer: { sdp: peerConnection.localDescription.sdp, type: peerConnection.localDescription.type },
      callerId: firebase.auth().currentUser.uid
    });

    callDoc.onSnapshot(snapshot => {
      const data = snapshot.data();
      if (!peerConnection.currentRemoteDescription && data && data.answer) {
        peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
      }
    });

    answerCandidates.onSnapshot(snapshot => {
      snapshot.docChanges().forEach(change => {
        if (change.type === 'added') {
          const candidate = new RTCIceCandidate(change.doc.data());
          peerConnection.addIceCandidate(candidate);
        }
      });
    });

    sendCallId(callDoc.id);
  } catch (error) {
    console.error("Error starting call:", error);
    alert('Error starting call: ' + error.message);
    hangUp();
  }
}

// Answer call
async function answerCall() {
  const callId = callIdInput.value;
  if (!callId) {
    alert('Please enter a Call ID');
    return;
  }

  try {
    callStatus.textContent = "Connecting...";
    videoCallContainer.style.display = 'flex';
    
    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    document.getElementById('localVideo').srcObject = localStream;

    callDoc = firestore.collection('calls').doc(callId);
    const offerCandidates = callDoc.collection('offerCandidates');
    const answerCandidates = callDoc.collection('answerCandidates');

    peerConnection = new RTCPeerConnection(servers);
    localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

    peerConnection.onicecandidate = event => {
      if (event.candidate) {
        answerCandidates.add(event.candidate.toJSON());
      }
    };

    peerConnection.ontrack = event => {
      document.getElementById('remoteVideo').srcObject = event.streams[0];
      callStatus.textContent = "Call connected";
    };

    const callData = (await callDoc.get()).data();
    await peerConnection.setRemoteDescription(new RTCSessionDescription(callData.offer));

    const answer = await peerConnection.createAnswer();
    await peerConnection.setLocalDescription(answer);

    await callDoc.update({ 
      answer: { sdp: peerConnection.localDescription.sdp, type: peerConnection.localDescription.type },
      answererId: firebase.auth().currentUser.uid
    });

    offerCandidates.onSnapshot(snapshot => {
      snapshot.docChanges().forEach(change => {
        if (change.type === 'added') {
          const candidate = new RTCIceCandidate(change.doc.data());
          peerConnection.addIceCandidate(candidate);
        }
      });
    });
  } catch (error) {
    console.error("Error answering call:", error);
    alert('Error answering call: ' + error.message);
    hangUp();
  }
}

// Hang up call
function hangUp() {
  if (peerConnection) peerConnection.close();
  if (localStream) localStream.getTracks().forEach(track => track.stop());
  document.getElementById('localVideo').srcObject = null;
  document.getElementById('remoteVideo').srcObject = null;
  videoCallContainer.style.display = 'none';
  if (callDoc) callDoc.delete();
}

// Toggle mute
function toggleMute() {
  if (localStream) {
    const audioTracks = localStream.getAudioTracks();
    audioTracks.forEach(track => {
      track.enabled = !track.enabled;
    });
    isMuted = !isMuted;
    const micButton = document.querySelector('.call-button i.fa-microphone');
    if (isMuted) {
      micButton.classList.remove('fa-microphone');
      micButton.classList.add('fa-microphone-slash');
    } else {
      micButton.classList.remove('fa-microphone-slash');
      micButton.classList.add('fa-microphone');
    }
  }
}

// Toggle video
function toggleVideo() {
  if (localStream) {
    const videoTracks = localStream.getVideoTracks();
    videoTracks.forEach(track => {
      track.enabled = !track.enabled;
    });
    isVideoOff = !isVideoOff;
    const videoButton = document.querySelector('.call-button i.fa-video');
    if (isVideoOff) {
      videoButton.classList.remove('fa-video');
      videoButton.classList.add('fa-video-slash');
    } else {
      videoButton.classList.remove('fa-video-slash');
      videoButton.classList.add('fa-video');
    }
  }
}
  
  </script>
</body>
</html>